---
title: "TO404Proj1"
author: "Jack Zimmerman, Danielle Bidigare, Jeff Sondheimer, John McCarthy, Eliza Brown"
date: "11/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, cache = TRUE}
#Loading a pre-made sample csv file made from another RMD file that took a 5% sample of every data monthly dataset

citibike <- read.csv("citibike_sample_total.csv")
```

```{r}
str(citibike)

#Getting rid of the X variable as it is just a counter
citibike$X <- NULL


```

### Factorizing
```{r}
#Setting all of the categorical variables to a factor
citibike$start.station.id <- as.factor(citibike$start.station.id)
citibike$start.station.name <- as.factor(citibike$start.station.name)

citibike$end.station.id <- as.factor(citibike$end.station.id)
citibike$end.station.name <- as.factor(citibike$end.station.name)

citibike$bikeid <- as.factor(citibike$bikeid)
citibike$usertype <- as.factor(citibike$usertype)

citibike$gender <- as.factor(citibike$gender)
#Give name to numeric gender classification
levels(citibike$gender)[levels(citibike$gender)=="0"] <- "Unknown"
levels(citibike$gender)[levels(citibike$gender)=="1"] <- "Male"
levels(citibike$gender)[levels(citibike$gender)=="2"] <- "Female"


#Creating an age column that will be easier to intepret
citibike$age <- 2019 - citibike$birth.year
head(citibike$age)

```
### Time and Data Cleaning
```{r}
library(tidyverse)


citibike$months <- months(as.Date(citibike$starttime))
citibike$months <- as.factor(citibike$months)

mode(citibike$months)
str(citibike$months)

citibike = citibike %>% mutate(date = substr(citibike$starttime, 1, 10) %>% parse_date(),
                               time = substr(citibike$starttime,12,19) %>% parse_time())

str(citibike$date)
str(citibike$time)

str(citibike)
```
```{r}
head(sort(citibike$age, decreasing = TRUE), 10)

#We don't know the reason why the age is wrong (they could have clicked on 1880 instead of 1980, but we can't justify this), so I am going to set the age of anyone over 90 to the mean of the sample

citibike$age <- ifelse(citibike$age >90, NA, citibike$age)
citibike$age <- ifelse(is.na(citibike$age) == TRUE, mean(citibike$age, na.rm = TRUE), citibike$age)

summary(citibike$age)

head(sort(citibike$tripduration, decreasing = TRUE), 10)
#All of these are likely "forgotten" and not returned. I wonder what the credit card bill looked like

filter(citibike, tripduration >1000000)
```
### Distance Between Stations
```{r}
#Load geosphere so we can use distHaversine function
library(geosphere)
#
startlocation <- select(citibike,c(start.station.latitude, start.station.longitude))
endlocation <- select(citibike, c(end.station.latitude, end.station.longitude))

str(startlocation)

citibike$distance <- distHaversine(select(citibike,c(start.station.latitude, start.station.longitude)),select(citibike, c(end.station.latitude, end.station.longitude)))

head(citibike$distance)
```


#Data Exploration
```{r}
str(citibike)
avergae_trip_duration <- mean(citibike$tripduration)
median_trip_duration <- median(citibike$tripduration)
shortest_trip <- min(citibike$tripduration, na.rm=TRUE)
longest_trip <- max(citibike$tripduration, na.rm=TRUE)
```

##The longest trip is `r longest_trip` seconds, and the shortest trip is `r shortest_trip` seconds.

#Seeing how many "forgotten" bike trips there are. It's unlikely that anyone would have a bike greater than a week, so that's the criteria we'll use for a forgotten bike

```{r}
forgotten_bikes <- nrow(citibike[citibike$tripduration > 60*24*7,])
forgotten_bikes
```

##See what percent of forgotten bikes are from customers. 
```{r}
round(nrow(citibike %>%
  filter( tripduration > 60*24*7 & usertype == "Customer") %>%
  select(c(tripduration, usertype)))  / 
  nrow(citibike %>%
  filter( tripduration > 60*24*7) %>%
  select(c(tripduration, usertype)))*100, digits = 2)
```

##We have `r forgotten_bikes` bike trips in our data sample.

```{r}
total_number_user <- nrow(citibike[citibike$usertype,])
total_number_user

number_customer <- nrow(citibike[citibike$usertype=="Customer",])
number_subscriber <- nrow(citibike[citibike$usertype=="Subscriber",])
number_customer/total_number_user
number_subscriber/total_number_user
```

```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

getmode(citibike$start.station.name)
#This is right next to the Chrysler building in Manhattan, so Pershing Square makes sense as the most popular start station

#Getting number of trips started at Pershing Square North
nrow(citibike[citibike$start.station.name == "Pershing Square North",])


#Most popular end station. I'm curious to see if Pershing Square is also the most popular end destination
getmode(citibike$end.station.name)
#and it is the most popular


#Representative share of most popular station

#Expected number of trips per station with an equal distribution
nrow(citibike)/length(levels(citibike$start.station.name))

#Pershing Square trips as a percentage of expected number of trips

nrow(citibike[citibike$start.station.name == "Pershing Square North",])/(nrow(citibike)/length(levels(citibike$start.station.name)))
#There is a 7x increase in the expected number of trips

```

##More data exploration
```{r}
#Avg trip duration by user
avg_tripduration_by_user <- round(tapply(citibike$tripduration,citibike$usertype,mean,na.rm=TRUE),2)
avg_tripduration_by_user
tripduration_baseplot <- ggplot(data=citibike,aes(x=usertype,y=tripduration))
tripduration_baseplot+geom_boxplot(outlier.colour="black",outlier.shape=16,outlier.size=2,notch=TRUE)+coord_cartesian(ylim=c(0,2500))


```
```{r}

#density of user types by trip duration
ggplot(data = subset(citibike, tripduration<24*60), aes(x=tripduration, fill=usertype)) + geom_density(alpha=.5)

```

```{r}
#density of usertype by time

citibike = citibike %>% mutate(date = substr(citibike$starttime, 1, 10) %>% parse_date(),
                               time = substr(citibike$starttime,12,19) %>% parse_time())


ggplot(data = citibike, aes(x = time, fill = usertype)) + geom_density(alpha=.5) + scale_fill_discrete("User Type")

#stats for subscribers trip duration at 6AM to 9AM and 4PM to 7PM (ie rush hour times)
citibike %>% filter(time>parse_time("6:00:00") & time<parse_time("9:00:00") & usertype == "Subscriber") %>% select(tripduration) %>% summary()

citibike %>% filter(time>parse_time("16:00:00") & time<parse_time("19:00:00") & usertype == "Subscriber") %>% select(tripduration) %>% summary()


citibike %>% group_by(date) %>% count()

```







